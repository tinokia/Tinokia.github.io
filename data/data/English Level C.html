<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>English Level C</title>

<style>
body{
  font-family: Arial;
  max-width: 900px;
  margin: auto;
  padding: 20px;
}
input, button{
  padding: 8px 15px;
  font-size: 16px;
}
.question{
  margin-bottom: 20px;
  border-bottom: 1px solid #ddd;
  padding-bottom: 10px;
}
.answers label{
  display: block;
  margin: 6px 0;
  cursor: pointer;
}
.correct{ color: green; font-weight: bold; }
.wrong{ color: red; font-weight: bold; }

.question p{
  font-size: 16px;   /* gi·∫£m nh·∫π */
  font-weight: normal;
}

.question b{
  font-weight: bold;
}

.answers label{
  font-size: 36px;   /* tƒÉng ƒë√°p √°n l√™n b·∫±ng c√¢u h·ªèi */
}  
</style>
</head>

<body>

<h2>üìù English Level C</h2>

<p>
  Nh·∫≠p s·ªë b√†i t·ª´ 1 -> 10:
  <input type="number" id="testNumber" min="1" style="width:80px">
  <button onclick="loadTest()">L√†m B√†i</button>
</p>

<form>
  <div id="quiz"></div>
  <div id="hiddenInputs"></div>
  <button type="button" onclick="submitTest()">N·ªôp B√†i</button>
</form>

<h3 id="result"></h3>

<script>
// ================= C·∫§U H√åNH =================
const QUESTIONS_PER_TEST  = 10;
const QUESTIONS_PER_SHEET = 300;

const SHEETS = ["Sheet1","Sheet2"];

const SHEET_BASE =
"https://opensheet.elk.sh/1cr6aMeOyEbDg6WfdOF4oDgg2BgNSSV53fv09duTdVaU/";

// ================= BI·∫æN =================
let allQuestions = [];
let currentQuestions = [];
let submitted = false;

// ================= TI·ªÜN √çCH =================
function shuffle(arr){
  for(let i = arr.length - 1; i > 0; i--){
    let j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

async function loadSheet(name){
  let r = await fetch(SHEET_BASE + name);
  return await r.json();
}

// ================= HELPER T√çNH B√ÄI‚ÄìSHEET =================
function getTestLocation(testNo){
  if(!Number.isInteger(testNo) || testNo < 1){
    return { error: "S·ªë b√†i kh√¥ng h·ª£p l·ªá" };
  }

  const questionsBefore = (testNo - 1) * QUESTIONS_PER_TEST;
  const sheetIndex =
    Math.floor(questionsBefore / QUESTIONS_PER_SHEET);

  if(sheetIndex >= SHEETS.length){
    return { error: "Kh√¥ng c√≥ b√†i n√†y" };
  }

  const offset =
    questionsBefore - sheetIndex * QUESTIONS_PER_SHEET;

  return {
    sheetName: SHEETS[sheetIndex],
    start: offset,
    end: offset + QUESTIONS_PER_TEST
  };
}

// ================= LOAD B√ÄI =================
async function loadTest(){
  let testNo = parseInt(
    document.getElementById("testNumber").value
  );

  const loc = getTestLocation(testNo);
  if(loc.error){
    alert(loc.error);
    return;
  }

  submitted = false;
  document.getElementById("result").innerText = "";

  allQuestions = await loadSheet(loc.sheetName);

  if(loc.end > allQuestions.length){
    alert("Kh√¥ng c√≥ b√†i n√†y");
    return;
  }

  currentQuestions =
    allQuestions.slice(loc.start, loc.end);

  let quizHTML = "";
  let hiddenHTML = "";

  currentQuestions.forEach((q,i)=>{
    let answers = [
      {key:"A", text:q.A},
      {key:"B", text:q.B},
      {key:"C", text:q.C},
      {key:"D", text:q.D}
    ];
    shuffle(answers);

    quizHTML += `
    <div class="question" id="qbox${i}">
      <p><b>C√¢u ${i+1}:</b> ${q.question}</p>
      <div class="answers">
        ${answers.map(a=>`
          <label data-key="${a.key}">
            <input type="radio" name="q${i}"
              onchange="saveAnswer(${i},'${a.key}')">
            ${a.text}
          </label>
        `).join("")}
      </div>
    </div>
    `;
    hiddenHTML += `<input type="hidden" id="text${i+1}">`;
  });

  document.getElementById("quiz").innerHTML = quizHTML;
  document.getElementById("hiddenInputs").innerHTML = hiddenHTML;
}

// ================= L∆ØU ƒê√ÅP √ÅN =================
function saveAnswer(i,val){
  if(submitted) return;
  document.getElementById("text"+(i+1)).value = val;
}

// ================= N·ªòP B√ÄI =================
function submitTest(){
  if(submitted) return;
  submitted = true;

  let score = 0;

  document.querySelectorAll("input[type=radio]")
    .forEach(r=>r.disabled = true);

  currentQuestions.forEach((q,i)=>{
    let userAns =
      document.getElementById("text"+(i+1)).value;

    document
      .querySelectorAll("#qbox"+i+" label")
      .forEach(lb=>{
        let k = lb.dataset.key;
        if(k === q.correct) lb.classList.add("correct");
        if(k === userAns && userAns !== q.correct)
          lb.classList.add("wrong");
      });

    if(userAns === q.correct) score++;
  });

  document.getElementById("result").innerText =
    "Your score: " + score + "/" + currentQuestions.length;
}
</script>

</body>
</html>